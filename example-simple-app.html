<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Library - Simple Example</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white p-8">

<div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">Canvas Library Demo</h1>

    <!-- Status -->
    <div id="status" class="bg-slate-800 rounded-lg p-4 mb-6">
        <p class="text-green-400">‚è≥ Initializing...</p>
    </div>

    <!-- Image Generation -->
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Image Generation</h2>
        <input
            type="text"
            id="imagePrompt"
            placeholder="Describe an image..."
            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 mb-3"
            value="A futuristic city at sunset with flying cars"
        />
        <button
            id="generateImageBtn"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition"
        >
            Generate Image
        </button>
        <div id="imageResult" class="mt-4"></div>
    </div>

    <!-- Text Generation -->
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Text Generation</h2>
        <input
            type="text"
            id="textPrompt"
            placeholder="Ask a question..."
            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 mb-3"
            value="Explain quantum computing in simple terms"
        />
        <button
            id="generateTextBtn"
            class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition"
        >
            Generate Text
        </button>
        <div id="textResult" class="mt-4 bg-slate-900 rounded-lg p-4 hidden"></div>
    </div>

    <!-- Speech Generation -->
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Speech Generation</h2>
        <input
            type="text"
            id="speechText"
            placeholder="Text to speak..."
            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 mb-3"
            value="Hello! This is a demo of the Canvas library text-to-speech capabilities."
        />
        <button
            id="generateSpeechBtn"
            class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition"
        >
            Generate Speech
        </button>
        <div id="speechResult" class="mt-4"></div>
    </div>

    <!-- Data Persistence -->
    <div class="bg-slate-800 rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Data Persistence</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <textarea
                    id="dataToSave"
                    placeholder="Enter data to save..."
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 h-32 mb-3"
                >{"message": "Hello from Canvas!", "timestamp": "2025-01-20"}</textarea>
                <button
                    id="saveDataBtn"
                    class="w-full px-6 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold transition"
                >
                    Save to Firestore
                </button>
            </div>
            <div>
                <div id="loadedData" class="bg-slate-900 rounded-lg p-4 h-32 mb-3 overflow-auto">
                    <p class="text-gray-400 italic">No data loaded yet</p>
                </div>
                <button
                    id="loadDataBtn"
                    class="w-full px-6 py-3 bg-orange-600 hover:bg-orange-700 rounded-lg font-semibold transition"
                >
                    Load from Firestore
                </button>
            </div>
        </div>
    </div>

    <!-- Code Comparison -->
    <div class="mt-8 bg-slate-800 rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">üìä Code Comparison</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <div>
                <h3 class="font-semibold mb-2 text-red-400">‚ùå Without Library (verbose)</h3>
                <pre class="bg-slate-900 rounded p-3 text-xs overflow-x-auto"><code>// Manual Firebase setup
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

if (__initial_auth_token) {
  await signInWithCustomToken(auth, __initial_auth_token);
} else {
  await signInAnonymously(auth);
}

// Manual image generation with retry
let retries = 5;
let delay = 1000;
let base64Image;

while (retries > 0) {
  try {
    const response = await fetch(
      'https://generativelanguage.googleapis.com/...',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          instances: [{ prompt: "..." }],
          parameters: { sampleCount: 1 }
        })
      }
    );
    const result = await response.json();
    base64Image = result.predictions[0].bytesBase64Encoded;
    break;
  } catch (error) {
    retries--;
    await new Promise(r => setTimeout(r, delay));
    delay *= 2;
  }
}

// ~50+ more lines for chunking, audio conversion, etc.
</code></pre>
            </div>
            <div>
                <h3 class="font-semibold mb-2 text-green-400">‚úÖ With Library (clean)</h3>
                <pre class="bg-slate-900 rounded p-3 text-xs overflow-x-auto"><code>import { initCanvas } from './canvas-lib.js';

// Initialize everything
const { gemini, assets } = await initCanvas('my-app');

// Generate image (with auto-retry & caching)
const imageUrl = await assets.getImage(
  'my-image',
  'A futuristic city at sunset'
);

// Display image
document.getElementById('result').src = imageUrl;

// That's it! The library handles:
// ‚úì Firebase setup
// ‚úì Authentication
// ‚úì API calls with retry logic
// ‚úì Firestore caching with chunking
// ‚úì Error handling
// ‚úì Data URL conversion
</code></pre>
            </div>
        </div>
        <div class="mt-4 bg-blue-900/20 border border-blue-500 rounded-lg p-4">
            <p class="font-semibold mb-2">üìâ Code Reduction:</p>
            <ul class="text-sm space-y-1">
                <li>‚Ä¢ <strong>~200 lines ‚Üí ~10 lines</strong> for full app setup</li>
                <li>‚Ä¢ <strong>Zero boilerplate</strong> - focus on your app logic</li>
                <li>‚Ä¢ <strong>Built-in caching</strong> - assets automatically cached in Firestore</li>
                <li>‚Ä¢ <strong>Automatic retry</strong> - exponential backoff built-in</li>
                <li>‚Ä¢ <strong>Type-safe paths</strong> - public/private data handled correctly</li>
            </ul>
        </div>
    </div>
</div>

<script type="module">
import { initCanvas } from './canvas-lib.js';

// ============================================
// INITIALIZATION
// ============================================
let gemini, firestore, assets, ui;

const statusEl = document.getElementById('status');

async function init() {
    try {
        statusEl.innerHTML = '<p class="text-blue-400">‚è≥ Initializing Canvas library...</p>';

        // This single line replaces ~50 lines of boilerplate!
        const canvas = await initCanvas('canvas-library-demo');
        gemini = canvas.gemini;
        firestore = canvas.firestore;
        assets = canvas.assets;
        ui = canvas.ui;

        statusEl.innerHTML = '<p class="text-green-400">‚úÖ Ready! Library initialized successfully.</p>';

        setupEventListeners();
    } catch (error) {
        statusEl.innerHTML = `<p class="text-red-400">‚ùå Error: ${error.message}</p>`;
        console.error(error);
    }
}

// ============================================
// EVENT LISTENERS
// ============================================
function setupEventListeners() {
    // Image Generation
    document.getElementById('generateImageBtn').addEventListener('click', async () => {
        const btn = document.getElementById('generateImageBtn');
        const prompt = document.getElementById('imagePrompt').value;
        const resultEl = document.getElementById('imageResult');

        btn.disabled = true;
        btn.textContent = '‚è≥ Generating...';
        resultEl.innerHTML = '<p class="text-blue-400">Generating image...</p>';

        try {
            // This handles: API call, retry logic, Firestore caching, chunking
            const imageUrl = await assets.getImage('demo-image', prompt, { aspectRatio: '16:9' });

            resultEl.innerHTML = `
                <img src="${imageUrl}" alt="Generated" class="w-full rounded-lg shadow-lg" />
                <p class="text-sm text-gray-400 mt-2">‚úì Image generated and cached to Firestore</p>
            `;
            ui.showToast('Image generated successfully!', 'success');
        } catch (error) {
            resultEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            ui.showToast('Image generation failed', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generate Image';
        }
    });

    // Text Generation
    document.getElementById('generateTextBtn').addEventListener('click', async () => {
        const btn = document.getElementById('generateTextBtn');
        const prompt = document.getElementById('textPrompt').value;
        const resultEl = document.getElementById('textResult');

        btn.disabled = true;
        btn.textContent = '‚è≥ Generating...';
        resultEl.classList.remove('hidden');
        resultEl.innerHTML = '<p class="text-blue-400">Thinking...</p>';

        try {
            // Generate text with retry logic built-in
            const text = await gemini.generateText(prompt);

            resultEl.innerHTML = `<p>${text}</p>`;
            ui.showToast('Text generated!', 'success');
        } catch (error) {
            resultEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            ui.showToast('Text generation failed', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generate Text';
        }
    });

    // Speech Generation
    document.getElementById('generateSpeechBtn').addEventListener('click', async () => {
        const btn = document.getElementById('generateSpeechBtn');
        const text = document.getElementById('speechText').value;
        const resultEl = document.getElementById('speechResult');

        btn.disabled = true;
        btn.textContent = '‚è≥ Generating...';
        resultEl.innerHTML = '<p class="text-blue-400">Generating speech...</p>';

        try {
            // This handles: TTS API, PCM‚ÜíWAV conversion, Firestore caching
            const audioUrl = await assets.getAudio('demo-speech', text, { voice: 'Puck' });

            resultEl.innerHTML = `
                <audio controls src="${audioUrl}" class="w-full"></audio>
                <p class="text-sm text-gray-400 mt-2">‚úì Speech generated and cached to Firestore</p>
            `;
            ui.showToast('Speech generated!', 'success');
        } catch (error) {
            resultEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            ui.showToast('Speech generation failed', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generate Speech';
        }
    });

    // Save Data
    document.getElementById('saveDataBtn').addEventListener('click', async () => {
        const btn = document.getElementById('saveDataBtn');
        const dataStr = document.getElementById('dataToSave').value;

        btn.disabled = true;
        btn.textContent = '‚è≥ Saving...';

        try {
            const data = JSON.parse(dataStr);

            // Simple Firestore save with automatic path handling
            await firestore.save('demo-data', data);

            ui.showToast('Data saved to Firestore!', 'success');
        } catch (error) {
            ui.showToast('Save failed: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save to Firestore';
        }
    });

    // Load Data
    document.getElementById('loadDataBtn').addEventListener('click', async () => {
        const btn = document.getElementById('loadDataBtn');
        const resultEl = document.getElementById('loadedData');

        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';

        try {
            // Simple Firestore load with automatic path handling
            const data = await firestore.load('demo-data');

            if (data) {
                resultEl.innerHTML = `<pre class="text-sm">${JSON.stringify(data, null, 2)}</pre>`;
                ui.showToast('Data loaded from Firestore!', 'success');
            } else {
                resultEl.innerHTML = '<p class="text-gray-400 italic">No data found</p>';
                ui.showToast('No saved data found', 'info');
            }
        } catch (error) {
            resultEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            ui.showToast('Load failed: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Load from Firestore';
        }
    });
}

// Start the app
init();
</script>

</body>
</html>
