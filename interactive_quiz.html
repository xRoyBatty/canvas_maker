<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food & Grammar Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }

        .question-card {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .theory-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .alarm-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #dc2626, #991b1b);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .drag-item {
            cursor: move;
            transition: all 0.2s;
        }

        .drag-item:hover {
            transform: scale(1.05);
        }

        .drag-item.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 50px;
            border: 2px dashed #6b7280;
            transition: all 0.3s;
        }

        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .drop-zone.filled {
            border-style: solid;
            border-color: #10b981;
        }

        .correct {
            background: rgba(16, 185, 129, 0.2) !important;
            border-color: #10b981 !important;
        }

        .incorrect {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
        }

        .leaderboard {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
        }

        .timer-display {
            font-variant-numeric: tabular-nums;
        }

        .sortable-item {
            cursor: move;
            transition: all 0.2s;
        }

        .sortable-item:hover {
            transform: translateX(5px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">

<!-- Leaderboard -->
<div class="leaderboard bg-slate-800/90 backdrop-blur rounded-xl p-4 border border-slate-700">
    <h3 class="text-lg font-bold mb-3">üèÜ Leaderboard</h3>
    <div id="leaderboard-list" class="space-y-2"></div>
</div>

<!-- Theory Modal -->
<div id="theory-modal" class="theory-modal hidden">
    <div class="bg-slate-800 rounded-xl p-8 max-w-2xl mx-4 border-2 border-blue-500">
        <h2 class="text-2xl font-bold mb-4" id="theory-title">Theory</h2>
        <div id="theory-content" class="text-gray-300 mb-6 space-y-4"></div>
        <div id="copy-instruction" class="hidden bg-yellow-900/50 border border-yellow-500 rounded-lg p-4 mb-4">
            <p class="font-semibold text-yellow-300">‚ö†Ô∏è PRZEPISZ TEORIƒò DO ZESZYTU ABY KONTYNUOWAƒÜ</p>
            <p class="text-sm text-yellow-200 mt-2">Sprawdzƒô czy to zrobi≈Çe≈õ po czasie (minimum 1 minuta).</p>
        </div>
        <div class="flex gap-4 items-center">
            <button id="theory-understand-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                Zrozumia≈Çem
            </button>
            <span id="theory-timer" class="text-gray-400 timer-display"></span>
        </div>
    </div>
</div>

<!-- Alarm Screen -->
<div id="alarm-screen" class="alarm-screen hidden">
    <div class="text-center">
        <div class="text-8xl mb-6">‚ö†Ô∏è</div>
        <h1 class="text-5xl font-bold mb-4">ALARM!</h1>
        <p class="text-2xl mb-6">Nie przepisa≈Çe≈õ teorii do zeszytu!</p>
        <p class="text-xl mb-8">Musisz poczekaƒá <span id="alarm-countdown" class="font-bold text-yellow-300">15</span> sekund</p>
        <p class="text-gray-300">Nastƒôpnym razem po≈õwiƒôƒá czas na naukƒô!</p>
    </div>
</div>

<!-- Start Screen / Lobby -->
<div id="start-screen" class="flex items-center justify-center min-h-screen">
    <div class="bg-slate-800/90 backdrop-blur rounded-2xl p-12 max-w-lg border-2 border-blue-500 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-4">üçé Food & Grammar Quiz</h1>
            <p class="text-xl text-gray-300 mb-2">Level B1-B2 | 33 Questions</p>
            <p class="text-gray-400 text-sm">Test your knowledge of food vocabulary and English grammar!</p>
        </div>

        <div class="mb-8">
            <label for="start-name-input" class="block text-lg font-semibold mb-3 text-gray-200">Your Name:</label>
            <input
                type="text"
                id="start-name-input"
                class="w-full bg-slate-900 border-2 border-slate-600 rounded-lg px-4 py-3 text-lg focus:border-blue-500 focus:outline-none transition"
                placeholder="Enter your name..."
                autocomplete="off"
            >
        </div>

        <button
            id="start-quiz-btn"
            class="w-full px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-lg font-bold text-xl transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        >
            üöÄ Start Quiz
        </button>

        <div class="mt-6 text-center text-sm text-gray-400">
            <p>‚è±Ô∏è Estimated time: 45-90 minutes</p>
            <p class="mt-1">üí° Tip: Read grammar theory carefully!</p>
        </div>
    </div>
</div>

<!-- Main Container -->
<div id="main-container" class="max-w-4xl mx-auto p-6 pb-32 hidden">
    <!-- Header -->
    <header class="mb-8">
        <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700">
            <h1 class="text-4xl font-bold mb-2">üçé Food & Grammar Quiz</h1>
            <div class="flex justify-between items-center mt-4">
                <div>
                    <p class="text-gray-300">Student: <span id="student-name-display" class="font-semibold text-blue-400"></span></p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-blue-400 timer-display" id="quiz-timer">00:00</div>
                    <p class="text-sm text-gray-400">Czas quizu</p>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-400 mb-2">
                    <span>Postƒôp</span>
                    <span id="progress-text">0/33</span>
                </div>
                <div class="bg-slate-700 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Question Container -->
    <div id="question-container"></div>

    <!-- Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-slate-800/90 backdrop-blur border-t border-slate-700 p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <button id="prev-btn" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                ‚Üê Poprzednie
            </button>
            <div id="score-display" class="text-xl font-bold">
                Punkty: <span id="score-value" class="text-green-400">0</span>
            </div>
            <button id="next-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                Nastƒôpne ‚Üí
            </button>
        </div>
    </div>
</div>

<script>
// ============================================
// QUIZ DATA & CONFIGURATION
// ============================================

// BACKEND CONFIGURATION
// Set USE_BACKEND to true and provide your API URL to enable persistent leaderboard
const USE_BACKEND = false; // Change to true to enable PHP backend
// RECOMMENDED: Use relative URL (automatically uses HTTPS if page is HTTPS)
// Example: '/api/leaderboard.php' or '/quizik/leaderboard.php'
const LEADERBOARD_API = '/api/leaderboard.php'; // Change to your backend path

// Placeholder for assets - replace with generated assets from Canvas app
const QUIZ_ASSETS = {
    'fish': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Fish Image</text></svg>',
    'strawberry': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Strawberry</text></svg>',
    'jam': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Jam</text></svg>',
    'fruits_vegetables': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="12">Fruits & Veg</text></svg>',
    'chicken': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Chicken</text></svg>',
    'chips': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Chips</text></svg>',
    'rice': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Rice</text></svg>',
    'sausages': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Sausages</text></svg>',
    'cheese': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Cheese</text></svg>',
    'strawberries_cream': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="12">Strawberries</text></svg>',
    'coffee_sugar': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="16">Coffee</text></svg>',
    'breakfast_club': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23cbd5e1" font-size="12">Breakfast</text></svg>'
};

const GRAMMAR_THEORIES = {
    'containers': {
        title: 'Teoria: Pojemniki i opakowania (Containers)',
        content: `
            <h3 class="font-bold text-lg mb-2">Najwa≈ºniejsze pojemniki w jƒôzyku angielskim:</h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>a jar</strong> - s≈Çoik (np. for jam, honey, pickles)</li>
                <li><strong>a bottle</strong> - butelka (np. for water, wine, juice)</li>
                <li><strong>a can</strong> - puszka (np. for cola, soup, vegetables)</li>
                <li><strong>a carton</strong> - karton (np. for milk, juice, eggs)</li>
                <li><strong>a bar</strong> - tabliczka/batonik (np. for chocolate, soap)</li>
            </ul>
            <div class="bg-blue-900/30 p-3 rounded">
                <p class="font-semibold">Przyk≈Çady u≈ºycia:</p>
                <p>‚úì There is a <u>jar</u> of jam in the cupboard.</p>
                <p>‚úì I need a <u>bottle</u> of water.</p>
                <p>‚úì Can you buy a <u>can</u> of cola?</p>
            </div>
        `
    },
    'articles': {
        title: 'Teoria: Przedimki a / an / - (Articles)',
        content: `
            <h3 class="font-bold text-lg mb-2">Kiedy u≈ºywamy przedimk√≥w?</h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>A</strong> - przed rzeczownikami policzalnymi w liczbie pojedynczej, kt√≥re zaczynajƒÖ siƒô od SP√ì≈ÅG≈ÅOSKI<br/>
                    <span class="text-blue-300">Przyk≈Çad: a lemon, a bar, a chocolate</span>
                </li>
                <li><strong>AN</strong> - przed rzeczownikami policzalnymi w liczbie pojedynczej, kt√≥re zaczynajƒÖ siƒô od SAMOG≈ÅOSKI (a, e, i, o, u)<br/>
                    <span class="text-blue-300">Przyk≈Çad: an egg, an apple, an orange</span>
                </li>
                <li><strong>- (brak przedimka)</strong> - przed rzeczownikami NIEPOLICZALNYMI lub w liczbie MNOGIEJ<br/>
                    <span class="text-blue-300">Przyk≈Çad: milk, flour, sugar, eggs (l. mnoga)</span>
                </li>
            </ul>
            <div class="bg-blue-900/30 p-3 rounded">
                <p class="font-semibold">Zapamiƒôtaj:</p>
                <p>Rzeczowniki policzalne: egg, lemon, bar, chocolate bar</p>
                <p>Rzeczowniki niepoliczalne: milk, flour, sugar, chocolate (bez opakowania)</p>
            </div>
        `
    },
    'quantifiers': {
        title: 'Teoria: Okre≈õlenia ilo≈õci (Quantifiers: much, many, some, any, a lot)',
        content: `
            <h3 class="font-bold text-lg mb-2">Jak m√≥wiƒá o ilo≈õci?</h3>
            <div class="space-y-3 mb-4">
                <div class="bg-green-900/30 p-3 rounded">
                    <p class="font-semibold">RZECZOWNIKI POLICZALNE (countable):</p>
                    <p>‚úì <strong>many</strong> - du≈ºo (w pytaniach i przeczeniach)<br/>
                    <span class="text-sm text-gray-300">How many biscuits are there?</span></p>
                    <p>‚úì <strong>some</strong> - trochƒô (w zdaniach twierdzƒÖcych)<br/>
                    <span class="text-sm text-gray-300">There are some biscuits.</span></p>
                    <p>‚úì <strong>any</strong> - jakie≈õ/≈ºadne (w pytaniach i przeczeniach)<br/>
                    <span class="text-sm text-gray-300">Are there any biscuits?</span></p>
                </div>

                <div class="bg-blue-900/30 p-3 rounded">
                    <p class="font-semibold">RZECZOWNIKI NIEPOLICZALNE (uncountable):</p>
                    <p>‚úì <strong>much</strong> - du≈ºo (w pytaniach i przeczeniach)<br/>
                    <span class="text-sm text-gray-300">How much bread is there?</span></p>
                    <p>‚úì <strong>some</strong> - trochƒô (w zdaniach twierdzƒÖcych)<br/>
                    <span class="text-sm text-gray-300">There is some bread.</span></p>
                    <p>‚úì <strong>any</strong> - trochƒô/wcale (w pytaniach i przeczeniach)<br/>
                    <span class="text-sm text-gray-300">Is there any bread?</span></p>
                </div>

                <div class="bg-purple-900/30 p-3 rounded">
                    <p class="font-semibold">DLA OBU TYP√ìW:</p>
                    <p>‚úì <strong>a lot (of)</strong> - du≈ºo (w zdaniach twierdzƒÖcych)<br/>
                    <span class="text-sm text-gray-300">There is a lot of bread. / There are a lot of biscuits.</span></p>
                </div>
            </div>
        `
    }
};

const QUESTIONS = [
    // Q1-8: Fill in the blank with images
    {
        id: 1,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'fish',
        question: 'Look at the picture and complete the word:',
        text: 'f_sh',
        answer: 'fish',
        alternatives: []
    },
    {
        id: 2,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'strawberry',
        question: 'Look at the picture and complete the word:',
        text: 'str_wberry',
        answer: 'strawberry',
        alternatives: []
    },
    {
        id: 3,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'jam',
        question: 'Look at the picture and complete the word:',
        text: 'j_m',
        answer: 'jam',
        alternatives: []
    },
    {
        id: 4,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'fruits_vegetables',
        question: 'The (0)________ and vegetables look yummy.',
        answer: 'fruit',
        alternatives: ['fruits']
    },
    {
        id: 5,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'chicken',
        question: 'And I want some (1) c_____________ too.',
        answer: 'chicken',
        alternatives: []
    },
    {
        id: 6,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'rice',
        question: 'I like chicken, but I want to try the Chinese (2) r_____________.',
        answer: 'rice',
        alternatives: []
    },
    {
        id: 7,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'sausages',
        question: 'Can I have the (3) s_____________?',
        answer: 'sausages',
        alternatives: []
    },
    {
        id: 8,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'cheese',
        question: 'Max: Are you still hungry? Sonia: Yes, I am! Can I have some 4 c_____________ and biscuits now?',
        answer: 'cheese',
        alternatives: []
    },
    {
        id: 9,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'strawberries_cream',
        question: 'I want some 5 s_____________ and cream.',
        answer: 'strawberries',
        alternatives: []
    },
    {
        id: 10,
        type: 'fill-blank',
        time: 60,
        points: 1,
        image: 'coffee_sugar',
        question: 'And I want some coffee with 6 s_____________.',
        answer: 'sugar',
        alternatives: []
    },

    // Q9-13: Multiple choice (categorization)
    {
        id: 11,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        question: 'Zakre≈õl s≈Çowa, kt√≥re NIE pasujƒÖ do podanej kategorii.<br/>Vegetables: tomatoes / potatoes / toast',
        options: ['tomatoes', 'potatoes', 'toast'],
        answer: 'toast'
    },
    {
        id: 12,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        question: 'Zakre≈õl s≈Çowa, kt√≥re NIE pasujƒÖ do podanej kategorii.<br/>Food from animals: pasta / ham / meat',
        options: ['pasta', 'ham', 'meat'],
        answer: 'pasta'
    },
    {
        id: 13,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        question: 'Zakre≈õl s≈Çowa, kt√≥re NIE pasujƒÖ do podanej kategorii.<br/>Fruit: apples / oranges / pancakes',
        options: ['apples', 'oranges', 'pancakes'],
        answer: 'pancakes'
    },
    {
        id: 14,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        question: 'Zakre≈õl s≈Çowa, kt√≥re NIE pasujƒÖ do podanej kategorii.<br/>Food from the sea: fish / tuna / yoghurt',
        options: ['fish', 'tuna', 'yoghurt'],
        answer: 'yoghurt'
    },
    {
        id: 15,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        question: 'Zakre≈õl s≈Çowa, kt√≥re NIE pasujƒÖ do podanej kategorii.<br/>Food from plants: cereal / milk / bread',
        options: ['cereal', 'milk', 'bread'],
        answer: 'milk'
    },

    // Q14: Drag and drop - THEORY REQUIRED
    {
        id: 16,
        type: 'drag-drop',
        time: 90,
        points: 1,
        theory: 'containers',
        question: 'Uzupe≈Çnij zdania podanymi s≈Çowami: bar, can, jar, bottle, carton',
        items: [
            { text: 'There is a _____ of cola in the fridge.', answer: 'can' },
            { text: "There's a _____ of water in the kitchen.", answer: 'bottle' },
            { text: 'We need to buy a _____ of jam in the supermarket.', answer: 'jar' },
            { text: "I'd like that _____ of chocolate, please.", answer: 'bar' },
            { text: "There isn't any juice in the _____.", answer: 'carton' }
        ],
        words: ['bar', 'can', 'jar', 'bottle', 'carton']
    },

    // Q15-21: Multiple choice (articles) - THEORY REQUIRED
    {
        id: 17,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: 'You need _____ milk',
        options: ['a', '-'],
        answer: '-'
    },
    {
        id: 18,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: '_____ egg',
        options: ['a', 'an'],
        answer: 'an'
    },
    {
        id: 19,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: '_____ flour',
        options: ['a', '-'],
        answer: '-'
    },
    {
        id: 20,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: '_____ chocolate (as material)',
        options: ['a', '-'],
        answer: '-'
    },
    {
        id: 21,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: '_____ bar of chocolate',
        options: ['a', '-'],
        answer: 'a'
    },
    {
        id: 22,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: '_____ sugar',
        options: ['an', '-'],
        answer: '-'
    },
    {
        id: 23,
        type: 'multiple-choice',
        time: 30,
        points: 1,
        theory: 'articles',
        question: 'You need _____ lemon for the topping too.',
        options: ['a', '-'],
        answer: 'a'
    },

    // Q22-23: Drag and drop (quantifiers) - THEORY REQUIRED
    {
        id: 24,
        type: 'drag-drop',
        time: 90,
        points: 1,
        theory: 'quantifiers',
        question: 'Uzupe≈Çnij dialog podanymi s≈Çowami: a lot, any, many, much, some',
        items: [
            { text: "Lilian: I'm hungry! Nigel: There's _____ bread in the kitchen.", answer: 'some' },
            { text: 'Lilian: How _____ bread is there?', answer: 'much' },
            { text: "Nigel: There's _____ of bread.", answer: 'a lot' },
            { text: 'Lilian: Good! We can make _____ sandwiches.', answer: 'some' }
        ],
        words: ['a lot', 'any', 'many', 'much', 'some']
    },
    {
        id: 25,
        type: 'drag-drop',
        time: 90,
        points: 1,
        theory: 'quantifiers',
        question: 'Uzupe≈Çnij dialog c.d.:',
        items: [
            { text: 'Nigel: Is there _____ butter?', answer: 'any' },
            { text: "Lilian: No, there isn't, so we can't make _____ sandwiches.", answer: 'any' },
            { text: 'Nigel: How _____ biscuits are there?', answer: 'many' }
        ],
        words: ['any', 'many', 'some', 'much']
    },

    // Q24: Reorder
    {
        id: 26,
        type: 'reorder',
        time: 90,
        points: 1,
        question: 'U≈Ç√≥≈º w odpowiedniej kolejno≈õci nastƒôpujƒÖce zdania, ≈ºeby utworzyƒá dialog. Pierwsze zdanie jest ju≈º na miejscu:<br/><strong>0. Are you ready to order? What would you like?</strong>',
        items: [
            { id: 1, text: 'Anything else?', order: 4 },
            { id: 2, text: 'And would you like anything to drink?', order: 2 },
            { id: 3, text: 'No, thank you.', order: 5 },
            { id: 4, text: "Yes, please. I'd like a glass of juice, please.", order: 3 },
            { id: 5, text: 'Can I have a pizza, please?', order: 1 }
        ]
    },

    // Q25-33: Reading comprehension
    {
        id: 27,
        type: 'reading',
        time: 600,
        points: 9,
        image: 'breakfast_club',
        passage: `<h3 class="font-bold text-xl mb-4">School breakfast clubs</h3>
        <p>Mornings are usually difficult for school children. Children often haven't got time to eat breakfast. They arrive at school hungry and have problems during lessons. In some schools there are breakfast clubs. Students can have a quick breakfast there. They can have cereal with milk or yoghurt, sandwiches and toast with jam or ham, and some fruit (usually apples or bananas). They drink tea or mineral water. After breakfast in the club, the children usually have some time to play and have a chat with their friends before they start their lessons. Breakfast at school helps children start a day with a smile. They are also never late for classes ‚Äì they are already at school.</p>`,
        questions: [
            { text: 'Some students don't have _________ before school.', answer: 'breakfast' },
            { text: 'Some students are ______________ when they come to school.', answer: 'hungry' },
            { text: 'In some schools there are ______________ clubs.', answer: 'breakfast' },
            { text: 'Students can often have some fruit, like bananas or ______________.', answer: 'apples' },
            { text: 'After breakfast, students can ______________ with their friends.', answer: 'chat', alternatives: ['play'] },
            { text: 'Children who eat breakfast at school are ______________ late for lessons.', answer: 'never' },
            { text: 'Children drink some tea or _________', answer: 'water', alternatives: ['mineral water'] },
            { text: 'Hungry children have ____________ during lessons.', answer: 'problems' },
            { text: 'Mornings are NOT _________ for school children', answer: 'easy', alternatives: ['simple'] }
        ]
    }
];

// ============================================
// STATE MANAGEMENT
// ============================================
let currentQuestionIndex = 0;
let score = 0;
let studentName = '';
let quizStartTime = Date.now();
let questionStartTime = Date.now();
let timerInterval;
let theoryStartTime = null;
let currentTheoryType = null;
let hasSeenTheory = {};
let wrongAfterTheory = {};
let isNavigationLocked = false; // NEW: Lock navigation during auto-advance
let autoAdvanceTimeout = null; // NEW: Track auto-advance timeout

// Leaderboard (simulated - in real deployment, use backend)
let leaderboard = [
    { name: 'Anna K.', score: 28, time: '15:23' },
    { name: 'Piotr M.', score: 26, time: '18:45' },
    { name: 'Maria W.', score: 25, time: '14:12' }
];

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function normalizeAnswer(answer) {
    return answer.toLowerCase().trim().replace(/\s+/g, ' ');
}

function checkAnswer(userAnswer, correctAnswer, alternatives = []) {
    const normalized = normalizeAnswer(userAnswer);
    if (normalized === normalizeAnswer(correctAnswer)) return true;

    for (const alt of alternatives) {
        if (normalized === normalizeAnswer(alt)) return true;
    }

    return false;
}

// ============================================
// THEORY MODAL FUNCTIONS
// ============================================
function showTheory(theoryType) {
    const theory = GRAMMAR_THEORIES[theoryType];
    if (!theory) return;

    currentTheoryType = theoryType;
    theoryStartTime = Date.now();

    const modal = document.getElementById('theory-modal');
    const title = document.getElementById('theory-title');
    const content = document.getElementById('theory-content');
    const copyInstruction = document.getElementById('copy-instruction');
    const timer = document.getElementById('theory-timer');

    title.textContent = theory.title;
    content.innerHTML = theory.content;

    // Show copy instruction if student got it wrong after seeing theory
    if (wrongAfterTheory[theoryType]) {
        copyInstruction.classList.remove('hidden');
    } else {
        copyInstruction.classList.add('hidden');
    }

    modal.classList.remove('hidden');

    // Update timer
    const timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - theoryStartTime) / 1000);
        timer.textContent = `Czas: ${formatTime(elapsed)}`;
    }, 1000);

    // Store interval ID to clear later
    modal.dataset.timerInterval = timerInterval;
}

function hideTheory() {
    const modal = document.getElementById('theory-modal');
    const timerInterval = modal.dataset.timerInterval;
    if (timerInterval) {
        clearInterval(parseInt(timerInterval));
    }
    modal.classList.add('hidden');
}

function handleTheoryUnderstand() {
    const elapsed = Math.floor((Date.now() - theoryStartTime) / 1000);
    const minTime = wrongAfterTheory[currentTheoryType] ? 60 : 30; // 60s if must copy, 30s otherwise

    if (elapsed < minTime) {
        // Show alarm
        showAlarm();
    } else {
        hasSeenTheory[currentTheoryType] = true;
        hideTheory();
    }
}

function showAlarm() {
    hideTheory();

    const alarm = document.getElementById('alarm-screen');
    const countdown = document.getElementById('alarm-countdown');
    alarm.classList.remove('hidden');

    let secondsLeft = 15;
    countdown.textContent = secondsLeft;

    const alarmInterval = setInterval(() => {
        secondsLeft--;
        countdown.textContent = secondsLeft;

        if (secondsLeft <= 0) {
            clearInterval(alarmInterval);
            alarm.classList.add('hidden');
            // Show theory again
            showTheory(currentTheoryType);
        }
    }, 1000);
}

// ============================================
// QUESTION RENDERING
// ============================================
function renderQuestion(question) {
    const container = document.getElementById('question-container');
    container.innerHTML = '';

    const card = document.createElement('div');
    card.className = 'question-card bg-slate-800/50 backdrop-blur rounded-xl p-8 border border-slate-700';

    let html = `
        <div class="flex justify-between items-start mb-6">
            <div>
                <span class="text-sm text-gray-400">Pytanie ${currentQuestionIndex + 1} z ${QUESTIONS.length}</span>
                <h2 class="text-2xl font-bold mt-1">Pytanie ${question.id}</h2>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">Czas</div>
                <div class="text-2xl font-bold text-blue-400 timer-display" id="question-timer">${formatTime(question.time)}</div>
            </div>
        </div>
    `;

    // Check if theory required
    if (question.theory && !hasSeenTheory[question.theory]) {
        card.innerHTML = html + `
            <div class="bg-yellow-900/30 border-2 border-yellow-500 rounded-lg p-6 text-center">
                <div class="text-5xl mb-4">üìö</div>
                <h3 class="text-xl font-bold mb-2">Najpierw musisz przeczytaƒá teoriƒô!</h3>
                <p class="text-gray-300 mb-4">To pytanie wymaga znajomo≈õci gramatyki.</p>
                <button onclick="showTheoryForQuestion()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
                    Poka≈º teoriƒô
                </button>
            </div>
        `;
        container.appendChild(card);
        return;
    }

    // Add image if exists
    if (question.image) {
        html += `<div class="mb-6 flex justify-center">
            <img src="${QUIZ_ASSETS[question.image]}" alt="Question image" class="rounded-lg max-w-md w-full">
        </div>`;
    }

    // Add passage for reading questions
    if (question.passage) {
        html += `<div class="bg-slate-900/50 rounded-lg p-6 mb-6 text-gray-300">${question.passage}</div>`;
    }

    html += `<div class="mb-6"><p class="text-lg text-gray-200">${question.question}</p></div>`;

    // Render based on type
    if (question.type === 'fill-blank') {
        html += `
            <input type="text" id="answer-input" class="w-full bg-slate-900 border-2 border-slate-600 rounded-lg p-4 text-white text-lg focus:border-blue-500 focus:outline-none" placeholder="Wpisz odpowied≈∫...">
            <button onclick="submitAnswer()" class="mt-4 px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-lg w-full">
                Sprawd≈∫ odpowied≈∫
            </button>
        `;
    } else if (question.type === 'multiple-choice') {
        html += '<div class="space-y-3">';
        question.options.forEach((option, index) => {
            html += `
                <button onclick="selectOption('${option}')" class="option-btn w-full text-left bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 rounded-lg p-4 transition" data-option="${option}">
                    ${option}
                </button>
            `;
        });
        html += '</div>';
    } else if (question.type === 'drag-drop') {
        html += '<div class="mb-6 flex flex-wrap gap-2" id="word-bank">';
        const shuffled = shuffleArray(question.words);
        shuffled.forEach(word => {
            html += `<span class="drag-item bg-blue-600 px-4 py-2 rounded-lg cursor-move" draggable="true" data-word="${word}">${word}</span>`;
        });
        html += '</div>';

        html += '<div class="space-y-4" id="drop-zones">';
        question.items.forEach((item, index) => {
            html += `
                <div class="flex items-center gap-3">
                    <div class="flex-1">
                        <p class="text-gray-300 mb-2">${item.text}</p>
                        <div class="drop-zone bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-4 min-h-[50px]" data-index="${index}" data-answer="${item.answer}">
                            PrzeciƒÖgnij tutaj
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        html += `<button onclick="submitDragDrop()" class="mt-6 px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-lg w-full">Sprawd≈∫ odpowiedzi</button>`;

    } else if (question.type === 'reorder') {
        html += '<div class="space-y-3" id="sortable-list">';
        const shuffled = shuffleArray(question.items);
        shuffled.forEach(item => {
            html += `
                <div class="sortable-item bg-slate-900 border-2 border-slate-600 rounded-lg p-4 flex items-center gap-3" data-id="${item.id}" data-order="${item.order}">
                    <span class="text-2xl cursor-move">‚ãÆ‚ãÆ</span>
                    <span class="flex-1">${item.text}</span>
                </div>
            `;
        });
        html += '</div>';
        html += `<button onclick="submitReorder()" class="mt-6 px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-lg w-full">Sprawd≈∫ kolejno≈õƒá</button>`;

    } else if (question.type === 'reading') {
        html += '<div class="space-y-4">';
        question.questions.forEach((q, index) => {
            html += `
                <div class="bg-slate-900/50 rounded-lg p-4">
                    <p class="text-gray-300 mb-2">${index + 1}. ${q.text}</p>
                    <input type="text" class="reading-input w-full bg-slate-800 border-2 border-slate-600 rounded-lg p-3 text-white" data-index="${index}" placeholder="Wpisz odpowied≈∫...">
                </div>
            `;
        });
        html += '</div>';
        html += `<button onclick="submitReading()" class="mt-6 px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-lg w-full">Sprawd≈∫ wszystkie odpowiedzi</button>`;
    }

    card.innerHTML = html;
    container.appendChild(card);

    // Setup drag and drop if needed
    if (question.type === 'drag-drop') {
        setupDragAndDrop();
    }

    // Setup sortable if needed
    if (question.type === 'reorder') {
        setupSortable();
    }

    // Start question timer
    startQuestionTimer(question.time);
}

// ============================================
// ANSWER SUBMISSION
// ============================================
function submitAnswer() {
    const question = QUESTIONS[currentQuestionIndex];
    const input = document.getElementById('answer-input');
    const userAnswer = input.value;

    const isCorrect = checkAnswer(userAnswer, question.answer, question.alternatives || []);

    if (isCorrect) {
        score += question.points;
        showFeedback(true, `Dobrze! Odpowied≈∫: ${question.answer}`);
        updateScore();
        scheduleAutoAdvance(1500);
    } else {
        showFeedback(false, `≈πle! Prawid≈Çowa odpowied≈∫: ${question.answer}`);

        // Check if this question required theory and student got it wrong
        if (question.theory && hasSeenTheory[question.theory]) {
            wrongAfterTheory[question.theory] = true;
        }

        scheduleAutoAdvance(2500);
    }
}

function selectOption(option) {
    const question = QUESTIONS[currentQuestionIndex];
    const isCorrect = option === question.answer;

    // Highlight selected
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.classList.remove('border-blue-500');
        if (btn.dataset.option === option) {
            btn.classList.add('border-blue-500');
        }
    });

    if (isCorrect) {
        score += question.points;
        showFeedback(true, 'Dobrze!');
        updateScore();
        scheduleAutoAdvance(1500);
    } else {
        showFeedback(false, `≈πle! Prawid≈Çowa odpowied≈∫: ${question.answer}`);

        if (question.theory && hasSeenTheory[question.theory]) {
            wrongAfterTheory[question.theory] = true;
        }

        scheduleAutoAdvance(2500);
    }
}

function submitDragDrop() {
    const question = QUESTIONS[currentQuestionIndex];
    const dropZones = document.querySelectorAll('.drop-zone');
    let correct = 0;

    dropZones.forEach(zone => {
        const droppedItem = zone.querySelector('.drag-item');
        if (droppedItem) {
            const userAnswer = droppedItem.dataset.word;
            const correctAnswer = zone.dataset.answer;

            if (normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer)) {
                zone.classList.add('correct');
                correct++;
            } else {
                zone.classList.add('incorrect');
            }
        }
    });

    const allCorrect = correct === question.items.length;

    if (allCorrect) {
        score += question.points;
        showFeedback(true, 'Wszystkie odpowiedzi poprawne!');
        updateScore();
        scheduleAutoAdvance(2000);
    } else {
        showFeedback(false, `Poprawnych: ${correct}/${question.items.length}`);

        if (question.theory && hasSeenTheory[question.theory]) {
            wrongAfterTheory[question.theory] = true;
        }

        scheduleAutoAdvance(3000);
    }
}

function submitReorder() {
    const question = QUESTIONS[currentQuestionIndex];
    const sortableItems = document.querySelectorAll('.sortable-item');
    let correct = 0;

    sortableItems.forEach((item, index) => {
        const expectedOrder = parseInt(item.dataset.order);
        const actualOrder = index + 1;

        if (expectedOrder === actualOrder) {
            item.classList.add('correct');
            correct++;
        } else {
            item.classList.add('incorrect');
        }
    });

    const allCorrect = correct === question.items.length;

    if (allCorrect) {
        score += question.points;
        showFeedback(true, 'Kolejno≈õƒá poprawna!');
        updateScore();
        scheduleAutoAdvance(2000);
    } else {
        showFeedback(false, `Poprawnych: ${correct}/${question.items.length}`);
        scheduleAutoAdvance(3000);
    }
}

function submitReading() {
    const question = QUESTIONS[currentQuestionIndex];
    const inputs = document.querySelectorAll('.reading-input');
    let correct = 0;

    inputs.forEach((input, index) => {
        const q = question.questions[index];
        const userAnswer = input.value;
        const isCorrect = checkAnswer(userAnswer, q.answer, q.alternatives || []);

        if (isCorrect) {
            input.classList.add('correct');
            correct++;
        } else {
            input.classList.add('incorrect');
        }
    });

    score += correct;

    if (correct === question.questions.length) {
        showFeedback(true, 'Wszystkie odpowiedzi poprawne!');
    } else {
        showFeedback(false, `Poprawnych: ${correct}/${question.questions.length}`);
    }

    updateScore();
    scheduleAutoAdvance(3000);
}

function showFeedback(isCorrect, message) {
    const container = document.getElementById('question-container');
    const feedback = document.createElement('div');
    feedback.className = `mt-4 p-4 rounded-lg ${isCorrect ? 'bg-green-900/50 border border-green-500' : 'bg-red-900/50 border border-red-500'}`;
    feedback.innerHTML = `
        <p class="font-semibold ${isCorrect ? 'text-green-300' : 'text-red-300'}">${message}</p>
    `;
    container.appendChild(feedback);
}

// ============================================
// DRAG AND DROP SETUP
// ============================================
function setupDragAndDrop() {
    const draggables = document.querySelectorAll('.drag-item');
    const dropZones = document.querySelectorAll('.drop-zone');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => {
            draggable.classList.add('dragging');
        });

        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
        });
    });

    dropZones.forEach(zone => {
        zone.addEventListener('dragover', e => {
            e.preventDefault();
            zone.classList.add('drag-over');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('drag-over');
        });

        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('drag-over');

            const dragging = document.querySelector('.dragging');
            if (dragging) {
                // Clear zone if already filled
                zone.innerHTML = '';

                // Clone the item
                const clone = dragging.cloneNode(true);
                zone.appendChild(clone);
                zone.classList.add('filled');

                // Hide original
                dragging.style.display = 'none';
            }
        });
    });
}

// ============================================
// SORTABLE SETUP (Simple version)
// ============================================
function setupSortable() {
    const list = document.getElementById('sortable-list');
    let draggedItem = null;

    const items = list.querySelectorAll('.sortable-item');
    items.forEach(item => {
        item.draggable = true;

        item.addEventListener('dragstart', function() {
            draggedItem = this;
            setTimeout(() => this.style.opacity = '0.5', 0);
        });

        item.addEventListener('dragend', function() {
            setTimeout(() => this.style.opacity = '1', 0);
        });

        item.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        item.addEventListener('drop', function(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                let allItems = [...list.querySelectorAll('.sortable-item')];
                let draggedIndex = allItems.indexOf(draggedItem);
                let targetIndex = allItems.indexOf(this);

                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }
            }
        });
    });
}

// ============================================
// NAVIGATION
// ============================================
function scheduleAutoAdvance(delayMs) {
    // Lock navigation
    isNavigationLocked = true;

    // Clear any existing timeout
    if (autoAdvanceTimeout) {
        clearTimeout(autoAdvanceTimeout);
    }

    // Schedule next question
    autoAdvanceTimeout = setTimeout(() => {
        isNavigationLocked = false;
        autoAdvanceTimeout = null;
        nextQuestion();
    }, delayMs);
}

function nextQuestion() {
    // Prevent navigation if locked (during auto-advance)
    if (isNavigationLocked) return;

    currentQuestionIndex++;

    if (currentQuestionIndex >= QUESTIONS.length) {
        finishQuiz();
        return;
    }

    updateProgress();
    renderQuestion(QUESTIONS[currentQuestionIndex]);
    updateNavigationButtons();
}

function previousQuestion() {
    // Prevent navigation if locked (during auto-advance)
    if (isNavigationLocked) return;

    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        updateProgress();
        renderQuestion(QUESTIONS[currentQuestionIndex]);
        updateNavigationButtons();
    }
}

function updateNavigationButtons() {
    document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
    document.getElementById('next-btn').textContent = currentQuestionIndex === QUESTIONS.length - 1 ? 'Zako≈Ñcz ‚úì' : 'Nastƒôpne ‚Üí';
}

function updateProgress() {
    const percentage = (currentQuestionIndex / QUESTIONS.length) * 100;
    document.getElementById('progress-bar').style.width = `${percentage}%`;
    document.getElementById('progress-text').textContent = `${currentQuestionIndex}/${QUESTIONS.length}`;
}

function updateScore() {
    document.getElementById('score-value').textContent = score;
}

// ============================================
// TIMER
// ============================================
function startQuizTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
        document.getElementById('quiz-timer').textContent = formatTime(elapsed);
    }, 1000);
}

function startQuestionTimer(duration) {
    const timerEl = document.getElementById('question-timer');
    if (!timerEl) return;

    let timeLeft = duration;
    questionStartTime = Date.now();

    const interval = setInterval(() => {
        timeLeft--;
        if (timerEl) {
            timerEl.textContent = formatTime(timeLeft);

            if (timeLeft <= 10) {
                timerEl.classList.add('text-red-400');
            }
        }

        if (timeLeft <= 0) {
            clearInterval(interval);
            // Auto-submit or skip question
            showFeedback(false, 'Czas minƒÖ≈Ç!');
            scheduleAutoAdvance(2000);
        }
    }, 1000);
}

// ============================================
// LEADERBOARD
// ============================================
async function updateLeaderboard() {
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = '<p class="text-gray-400 text-sm text-center">≈Åadowanie...</p>';

    if (!USE_BACKEND) {
        // Use local leaderboard (offline mode)
        renderLeaderboard(leaderboard);
        return;
    }

    // Fetch from backend
    try {
        const response = await fetch(LEADERBOARD_API);
        const data = await response.json();

        if (data.success) {
            renderLeaderboard(data.scores);
        } else {
            throw new Error('Backend returned error');
        }
    } catch (error) {
        console.error('Leaderboard fetch error:', error);
        list.innerHTML = '<p class="text-red-400 text-sm text-center">‚ö†Ô∏è B≈ÇƒÖd wczytywania</p>';
        // Fallback to local
        setTimeout(() => renderLeaderboard(leaderboard), 2000);
    }
}

function renderLeaderboard(scores) {
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = '';

    if (!scores || scores.length === 0) {
        list.innerHTML = '<p class="text-gray-400 text-sm text-center">Brak wynik√≥w</p>';
        return;
    }

    // Sort by score desc, then time asc
    const sorted = [...scores].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.time.localeCompare(b.time);
    });

    sorted.slice(0, 20).forEach((entry, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 bg-slate-900/50 rounded-lg p-2';
        div.innerHTML = `
            <span class="text-lg">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üë§'}</span>
            <span class="flex-1 truncate">${entry.name}</span>
            <span class="font-bold text-green-400">${entry.score}</span>
        `;
        list.appendChild(div);
    });
}

// ============================================
// FINISH QUIZ
// ============================================
async function finishQuiz() {
    const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
    const timeStr = formatTime(elapsed);
    let rank = null;

    // Submit to backend if enabled
    if (USE_BACKEND && studentName) {
        try {
            const response = await fetch(LEADERBOARD_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: studentName,
                    score: score,
                    time: timeStr
                })
            });

            const data = await response.json();
            if (data.success) {
                rank = data.rank;
                console.log('Score submitted! Rank:', rank);
                await updateLeaderboard(); // Refresh leaderboard
            } else {
                console.error('Backend error:', data.error);
            }
        } catch (error) {
            console.error('Failed to submit score:', error);
        }
    }

    // Add to local leaderboard (fallback or offline mode)
    if (studentName) {
        leaderboard.push({
            name: studentName,
            score: score,
            time: timeStr
        });
        if (!USE_BACKEND) {
            updateLeaderboard();
        }
    }

    const container = document.getElementById('question-container');
    const maxScore = QUESTIONS.reduce((sum, q) => sum + q.points, 0);
    const percentage = Math.round((score / maxScore) * 100);

    let rankMessage = '';
    if (rank) {
        const medals = { 1: 'ü•á', 2: 'ü•à', 3: 'ü•â' };
        rankMessage = `<p class="text-2xl font-bold mb-4">${medals[rank] || 'üèÖ'} Miejsce ${rank} w rankingu!</p>`;
    }

    container.innerHTML = `
        <div class="text-center bg-slate-800/50 backdrop-blur rounded-xl p-12 border border-slate-700">
            <div class="text-8xl mb-6">üéâ</div>
            <h2 class="text-4xl font-bold mb-4">Quiz uko≈Ñczony!</h2>
            <div class="text-6xl font-bold text-green-400 mb-6">${score} / ${maxScore}</div>
            <p class="text-xl text-gray-300 mb-2">Wynik: ${percentage}%</p>
            <p class="text-lg text-gray-400 mb-4">Czas: ${timeStr}</p>
            ${rankMessage}
            <p class="text-lg text-gray-400 mb-8">≈öwietna robota, ${studentName || 'uczniu'}!</p>
            <button onclick="location.reload()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-lg">
                Spr√≥buj ponownie
            </button>
        </div>
    `;

    clearInterval(timerInterval);
}

// ============================================
// GLOBAL FUNCTIONS (for onclick)
// ============================================
window.showTheoryForQuestion = function() {
    const question = QUESTIONS[currentQuestionIndex];
    showTheory(question.theory);
};

window.submitAnswer = submitAnswer;
window.selectOption = selectOption;
window.submitDragDrop = submitDragDrop;
window.submitReorder = submitReorder;
window.submitReading = submitReading;

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    const startScreen = document.getElementById('start-screen');
    const mainContainer = document.getElementById('main-container');
    const startNameInput = document.getElementById('start-name-input');
    const startQuizBtn = document.getElementById('start-quiz-btn');

    // Focus on name input
    startNameInput.focus();

    // Start quiz function
    function startQuiz() {
        const name = startNameInput.value.trim();

        if (!name) {
            startNameInput.classList.add('border-red-500');
            startNameInput.focus();
            return;
        }

        studentName = name;

        // Hide start screen, show main container
        startScreen.classList.add('hidden');
        mainContainer.classList.remove('hidden');

        // Update student name display
        document.getElementById('student-name-display').textContent = studentName;

        // Start timers
        quizStartTime = Date.now();
        startQuizTimer();

        // Update leaderboard
        updateLeaderboard();

        // Render first question
        renderQuestion(QUESTIONS[currentQuestionIndex]);
        updateNavigationButtons();
        updateProgress();
    }

    // Start quiz on button click
    startQuizBtn.addEventListener('click', startQuiz);

    // Start quiz on Enter in name input
    startNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            startQuiz();
        }
    });

    // Remove red border on input
    startNameInput.addEventListener('input', () => {
        startNameInput.classList.remove('border-red-500');
    });

    // Setup navigation (for when quiz starts)
    document.getElementById('prev-btn').addEventListener('click', previousQuestion);
    document.getElementById('next-btn').addEventListener('click', nextQuestion);

    // Setup theory button
    document.getElementById('theory-understand-btn').addEventListener('click', handleTheoryUnderstand);

    // Enter key support for answers
    document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !startScreen.classList.contains('hidden')) {
            // Start screen is visible - handled above
            return;
        }

        if (e.key === 'Enter' && startScreen.classList.contains('hidden') && !isNavigationLocked) {
            const question = QUESTIONS[currentQuestionIndex];

            // Check if there's a submit button for current question type
            if (question.type === 'drag-drop') {
                const submitBtn = document.querySelector('button[onclick="submitDragDrop()"]');
                if (submitBtn) submitBtn.click();
            } else if (question.type === 'reorder') {
                const submitBtn = document.querySelector('button[onclick="submitReorder()"]');
                if (submitBtn) submitBtn.click();
            } else if (question.type === 'reading') {
                const submitBtn = document.querySelector('button[onclick="submitReading()"]');
                if (submitBtn) submitBtn.click();
            } else if (question.type === 'fill-blank') {
                const submitBtn = document.querySelector('button[onclick="checkAnswer()"]');
                if (submitBtn) submitBtn.click();
            }
            // For multiple-choice, Enter is not needed (clicking option auto-submits)
        }
    });
});
</script>

</body>
</html>
