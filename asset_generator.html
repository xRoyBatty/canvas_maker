<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Asset Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .asset-card {
            transition: all 0.3s;
        }
        .asset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white p-8">

<div class="max-w-7xl mx-auto">
    <header class="mb-8">
        <h1 class="text-4xl font-bold mb-2">Quiz Asset Generator</h1>
        <p class="text-gray-300">Generate all images needed for the food quiz</p>
    </header>

    <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 mb-6">
        <div class="flex gap-4 mb-4">
            <button id="generate-all-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                üé® Generate All Assets
            </button>
            <button id="download-all-btn" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition" disabled>
                ‚¨áÔ∏è Pobierz Quiz (HTML + Assety)
            </button>
            <button id="download-backend-btn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition" disabled>
                üì¶ Pobierz Backend (PHP)
            </button>
        </div>
        <div id="progress" class="hidden">
            <div class="bg-slate-700 rounded-full h-3 overflow-hidden">
                <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-400 mt-2">Ready to generate...</p>
        </div>
    </div>

    <div id="assets-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>

<script type="module">
const ASSETS_TO_GENERATE = [
    { id: 'fish', prompt: 'Fresh raw fish on white plate, clean product photography, white background, 8k quality', filename: 'fish.png' },
    { id: 'strawberry', prompt: 'Fresh red strawberry with green leaves, clean product photography, white background, 8k quality', filename: 'strawberry.png' },
    { id: 'jam', prompt: 'Glass jar of strawberry jam with red contents, clean product photography, white background, 8k quality', filename: 'jam.png' },
    { id: 'fruits_vegetables', prompt: 'Fresh colorful fruits and vegetables display at market, tomatoes, lettuce, carrots, apples, oranges, clean photography, 8k quality', filename: 'fruits_vegetables.png' },
    { id: 'chicken', prompt: 'Grilled chicken breast on white plate, clean food photography, white background, 8k quality', filename: 'chicken.png' },
    { id: 'chips', prompt: 'Golden french fries on white plate, clean food photography, white background, 8k quality', filename: 'chips.png' },
    { id: 'rice', prompt: 'Bowl of white cooked rice with chopsticks, Chinese style, clean food photography, white background, 8k quality', filename: 'rice.png' },
    { id: 'sausages', prompt: 'Grilled sausages on white plate, clean food photography, white background, 8k quality', filename: 'sausages.png' },
    { id: 'cheese', prompt: 'Piece of yellow cheese with holes on white plate, clean product photography, white background, 8k quality', filename: 'cheese.png' },
    { id: 'strawberries_cream', prompt: 'Fresh strawberries with whipped cream in bowl, clean food photography, white background, 8k quality', filename: 'strawberries_cream.png' },
    { id: 'coffee_sugar', prompt: 'Cup of black coffee with sugar cubes on side, clean food photography, white background, 8k quality', filename: 'coffee_sugar.png' },
    { id: 'breakfast_club', prompt: 'School cafeteria breakfast scene with students eating cereal, toast, fruit, happy atmosphere, bright lighting, 8k quality', filename: 'breakfast_club.png' }
];

let generatedAssets = {};

const generateImage = async (prompt) => {
    return callWithRetry(async () => {
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                instances: [{ prompt: prompt }],
                parameters: { sampleCount: 1, aspectRatio: "1:1" }
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();

        if (result.predictions?.[0]?.bytesBase64Encoded) {
            return result.predictions[0].bytesBase64Encoded;
        }
        throw new Error("Invalid image data");
    });
};

const callWithRetry = async (apiCall, maxRetries = 5, initialDelay = 2000) => {
    let delay = initialDelay;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            return await apiCall();
        } catch (error) {
            if (attempt === maxRetries) throw error;
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
        }
    }
};

function createAssetCard(asset) {
    const div = document.createElement('div');
    div.className = 'asset-card bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700';
    div.id = `card-${asset.id}`;
    div.innerHTML = `
        <div class="aspect-square bg-slate-900 rounded-lg mb-3 flex items-center justify-center" id="preview-${asset.id}">
            <span class="text-gray-500">Not generated</span>
        </div>
        <h3 class="font-semibold mb-2">${asset.filename}</h3>
        <div id="status-${asset.id}" class="text-sm text-gray-400">Waiting...</div>
        <button onclick="generateSingle('${asset.id}')" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm w-full">
            Generate This
        </button>
    `;
    return div;
}

async function generateAll() {
    const btn = document.getElementById('generate-all-btn');
    const downloadBtn = document.getElementById('download-all-btn');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    btn.disabled = true;
    btn.textContent = 'üé® Generating...';
    progress.classList.remove('hidden');

    let completed = 0;
    const total = ASSETS_TO_GENERATE.length;

    for (const asset of ASSETS_TO_GENERATE) {
        try {
            const statusEl = document.getElementById(`status-${asset.id}`);
            statusEl.textContent = 'Generating...';
            statusEl.className = 'text-sm text-blue-400';

            progressText.textContent = `Generating ${asset.filename}...`;

            const base64 = await generateImage(asset.prompt);
            generatedAssets[asset.id] = {
                base64: base64,
                filename: asset.filename
            };

            const previewEl = document.getElementById(`preview-${asset.id}`);
            previewEl.innerHTML = `<img src="data:image/png;base64,${base64}" class="w-full h-full object-cover rounded-lg">`;

            statusEl.textContent = '‚úì Generated';
            statusEl.className = 'text-sm text-green-400';

            completed++;
            const percentage = (completed / total) * 100;
            progressBar.style.width = `${percentage}%`;

        } catch (error) {
            const statusEl = document.getElementById(`status-${asset.id}`);
            statusEl.textContent = `‚úó Error: ${error.message}`;
            statusEl.className = 'text-sm text-red-400';
        }
    }

    progressText.textContent = 'All assets generated!';
    btn.textContent = '‚úì All Generated';
    downloadBtn.disabled = false;
}

async function generateSingle(assetId) {
    const asset = ASSETS_TO_GENERATE.find(a => a.id === assetId);
    if (!asset) return;

    const statusEl = document.getElementById(`status-${assetId}`);
    statusEl.textContent = 'Generating...';
    statusEl.className = 'text-sm text-blue-400';

    try {
        const base64 = await generateImage(asset.prompt);
        generatedAssets[assetId] = {
            base64: base64,
            filename: asset.filename
        };

        const previewEl = document.getElementById(`preview-${assetId}`);
        previewEl.innerHTML = `<img src="data:image/png;base64,${base64}" class="w-full h-full object-cover rounded-lg">`;

        statusEl.textContent = '‚úì Generated';
        statusEl.className = 'text-sm text-green-400';

    } catch (error) {
        statusEl.textContent = `‚úó Error: ${error.message}`;
        statusEl.className = 'text-sm text-red-400';
    }
}

function downloadAllAssets() {
    // Build the QUIZ_ASSETS object
    let assetsCode = 'const QUIZ_ASSETS = {\n';

    for (const [id, data] of Object.entries(generatedAssets)) {
        assetsCode += `    '${id}': 'data:image/png;base64,${data.base64}',\n`;
    }

    assetsCode += '};';

    // Inject assets into quiz template
    const quizHTML = QUIZ_TEMPLATE.replace('/*INJECT_ASSETS_HERE*/', assetsCode);

    // Download complete quiz
    const blob = new Blob([quizHTML], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'interactive_quiz_READY.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Enable backend download button
    document.getElementById('download-backend-btn').disabled = false;

    // Show instructions
    const instructions = `
‚úÖ GOTOWY QUIZ POBRANY!

Plik: interactive_quiz_READY.html (wszystkie assety wbudowane!)

OPCJONALNIE: Kliknij "Pobierz Backend" aby dostaƒá PHP API dla leaderboard

Wdro≈ºenie (bez backendu):
   scp interactive_quiz_READY.html user@vps:~/quiz.html
   python3 -m http.server 8080
   Quiz: http://tw√≥j-vps-ip:8080/quiz.html

Wdro≈ºenie (z backendem PHP):
   Pobierz backend ‚Üí wgraj do /var/www/html/api/
   Edytuj quiz: USE_BACKEND = true
   Instrukcje w backend/README.md

Gotowe! üéâ
    `;

    alert(instructions);
}

function downloadBackend() {
    // Download leaderboard.php
    const phpBlob = new Blob([PHP_BACKEND_CODE], { type: 'text/plain' });
    let url = URL.createObjectURL(phpBlob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'leaderboard.php';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Download .htaccess
    const htaccessBlob = new Blob([HTACCESS_CODE], { type: 'text/plain' });
    url = URL.createObjectURL(htaccessBlob);
    a = document.createElement('a');
    a.href = url;
    a.download = '.htaccess';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Download README
    const readmeBlob = new Blob([BACKEND_README], { type: 'text/markdown' });
    url = URL.createObjectURL(readmeBlob);
    a = document.createElement('a');
    a.href = url;
    a.download = 'BACKEND_README.md';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert(`
üì¶ BACKEND POBRANY! (3 pliki)

Pobrane pliki:
1. leaderboard.php - API backend
2. .htaccess - konfiguracja Apache
3. BACKEND_README.md - instrukcje instalacji

Instalacja:
1. Wgraj pliki do: /var/www/html/api/
2. Ustaw uprawnienia:
   sudo chown -R www-data:www-data /var/www/html/api
3. Edytuj quiz:
   USE_BACKEND = true
   LEADERBOARD_API = 'http://tw√≥j-vps/api/leaderboard.php'
4. Przeczytaj BACKEND_README.md dla szczeg√≥≈Ç√≥w

Gotowe!
    `);
}

// PHP Backend code (embedded as strings)
const PHP_BACKEND_CODE = `<?php
/**
 * Simple PHP Backend for Quiz Leaderboard
 * Stores scores in JSON file (no database needed)
 */

header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST');
header('Access-Control-Allow-Headers: Content-Type');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

$SCORES_FILE = __DIR__ . '/scores.json';
$MAX_SCORES = 100;
$RATE_LIMIT_FILE = __DIR__ . '/rate_limits.json';
$RATE_LIMIT_SECONDS = 60;

function readScores($file) {
    if (!file_exists($file)) return [];
    return json_decode(file_get_contents($file), true) ?: [];
}

function writeScores($file, $scores) {
    file_put_contents($file, json_encode($scores, JSON_PRETTY_PRINT));
}

function checkRateLimit($file, $ip, $limitSeconds) {
    $limits = readScores($file);
    $now = time();
    $limits = array_filter($limits, function($timestamp) use ($now, $limitSeconds) {
        return ($now - $timestamp) < $limitSeconds;
    });
    if (isset($limits[$ip])) {
        return ['allowed' => false, 'secondsLeft' => $limitSeconds - ($now - $limits[$ip])];
    }
    $limits[$ip] = $now;
    writeScores($file, $limits);
    return ['allowed' => true];
}

function validateScore($data) {
    if (!isset($data['name']) || !isset($data['score']) || !isset($data['time'])) return false;
    $name = trim($data['name']);
    if (strlen($name) < 1 || strlen($name) > 30) return false;
    if (!preg_match('/^[a-zA-Z0-9\\s\\.\\-]+$/', $name)) return false;
    $score = intval($data['score']);
    if ($score < 0 || $score > 42) return false;
    if (!preg_match('/^\\d{2}:\\d{2}$/', $data['time'])) return false;
    return true;
}

if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    $scores = readScores($SCORES_FILE);
    usort($scores, function($a, $b) {
        if ($b['score'] !== $a['score']) return $b['score'] - $a['score'];
        list($aMin, $aSec) = explode(':', $a['time']);
        list($bMin, $bSec) = explode(':', $b['time']);
        return (intval($aMin) * 60 + intval($aSec)) - (intval($bMin) * 60 + intval($bSec));
    });
    echo json_encode(['success' => true, 'scores' => array_slice($scores, 0, 20), 'total' => count($scores)]);
    exit();
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $input = json_decode(file_get_contents('php://input'), true);
    if (!validateScore($input)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'Invalid score data']);
        exit();
    }
    $clientIP = $_SERVER['REMOTE_ADDR'];
    $rateLimitCheck = checkRateLimit($RATE_LIMIT_FILE, $clientIP, $RATE_LIMIT_SECONDS);
    if (!$rateLimitCheck['allowed']) {
        http_response_code(429);
        echo json_encode(['success' => false, 'error' => 'Too many submissions. Wait ' . $rateLimitCheck['secondsLeft'] . 's']);
        exit();
    }
    $scores = readScores($SCORES_FILE);
    $scores[] = [
        'name' => htmlspecialchars($input['name'], ENT_QUOTES, 'UTF-8'),
        'score' => intval($input['score']),
        'time' => $input['time'],
        'timestamp' => time(),
        'date' => date('Y-m-d H:i:s')
    ];
    usort($scores, function($a, $b) {
        if ($b['score'] !== $a['score']) return $b['score'] - $a['score'];
        list($aMin, $aSec) = explode(':', $a['time']);
        list($bMin, $bSec) = explode(':', $b['time']);
        return (intval($aMin) * 60 + intval($aSec)) - (intval($bMin) * 60 + intval($bSec));
    });
    $scores = array_slice($scores, 0, $MAX_SCORES);
    writeScores($SCORES_FILE, $scores);
    echo json_encode(['success' => true, 'message' => 'Score submitted', 'rank' => array_search($input['name'], array_column($scores, 'name')) + 1]);
    exit();
}

http_response_code(405);
echo json_encode(['success' => false, 'error' => 'Method not allowed']);
`;

const HTACCESS_CODE = `<FilesMatch "^(scores|rate_limits)\\.json$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

<IfModule mod_headers.c>
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type"
</IfModule>

Options -Indexes
`;

const BACKEND_README = `# PHP Backend Installation

## Quick Install (Apache)

\`\`\`bash
sudo mkdir -p /var/www/html/api
sudo mv leaderboard.php .htaccess /var/www/html/api/
sudo chown -R www-data:www-data /var/www/html/api
sudo chmod 755 /var/www/html/api
sudo systemctl restart apache2
\`\`\`

## Configure Quiz

Edit interactive_quiz_READY.html:

\`\`\`javascript
const USE_BACKEND = true;
// RECOMMENDED: Use relative URL (auto HTTPS!)
const LEADERBOARD_API = '/api/leaderboard.php';
// OR full URL if needed:
// const LEADERBOARD_API = 'https://your-domain.com/api/leaderboard.php';
\`\`\`

## Test

\`\`\`bash
# GET leaderboard
curl https://your-domain.com/api/leaderboard.php

# POST score
curl -X POST https://your-domain.com/api/leaderboard.php \\
  -H "Content-Type: application/json" \\
  -d '{"name":"Test","score":25,"time":"10:30"}'
\`\`\`

## Features

‚úÖ No database needed (uses JSON files)
‚úÖ Rate limiting (60s between submissions)
‚úÖ Input validation
‚úÖ CORS enabled
‚úÖ Top 100 scores kept

## Files Created

- scores.json (created automatically)
- rate_limits.json (created automatically)

## Troubleshooting

**403 Forbidden:**
\`\`\`bash
sudo chown -R www-data:www-data /var/www/html/api
\`\`\`

**Can't save scores:**
\`\`\`bash
sudo chmod 666 /var/www/html/api/scores.json
\`\`\`
`;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    const grid = document.getElementById('assets-grid');
    ASSETS_TO_GENERATE.forEach(asset => {
        grid.appendChild(createAssetCard(asset));
    });

    document.getElementById('generate-all-btn').addEventListener('click', generateAll);
    document.getElementById('download-all-btn').addEventListener('click', downloadAllAssets);
    document.getElementById('download-backend-btn').addEventListener('click', downloadBackend);
});

window.generateSingle = generateSingle;
</script>

</body>
</html>
